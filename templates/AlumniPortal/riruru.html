<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NeoChat AI - Alumni Portal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.2.12/marked.min.js"></script>
  <style>
    :root {
      --primary-color: #7c4dff;
      --secondary-color: #b388ff;
      --text-primary: #333;
      --text-secondary: #666;
      --background-primary: #fff;
      --background-secondary: #f5f7fb;
      --background-tertiary: #edf0f7;
      --ai-message-bg: #f0f4ff;
      --user-message-bg: #7c4dff;
      --user-message-text: #fff;
      --border-color: #e0e0e0;
      --shadow-color: rgba(0, 0, 0, 0.1);
      --animation-speed: 0.3s;
      --border-radius: 12px;
      --typing-indicator-color: var(--primary-color);
      --font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    }

    .dark-mode {
      --primary-color: #9d74ff;
      --secondary-color: #b388ff;
      --text-primary: #e0e0e0;
      --text-secondary: #aaaaaa;
      --background-primary: #1a1a1a;
      --background-secondary: #252525;
      --background-tertiary: #333333;
      --ai-message-bg: #2d2d3d;
      --user-message-bg: #9d74ff;
      --user-message-text: #fff;
      --border-color: #444;
      --shadow-color: rgba(0, 0, 0, 0.6);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: var(--font-family);
      transition: background-color var(--animation-speed),
        color var(--animation-speed);
    }

    body {
      background-color: var(--background-secondary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      font-family: var(--font-family);
    }

    .code-copy-container {
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 10;
    }

    .code-copy-button {
      background-color: rgba(255, 255, 255, 0.1);
      color: #ddd;
      border: none;
      border-radius: 4px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .code-copy-button:hover {
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .code-copy-button.copied {
      background-color: #4caf50;
      color: white;
    }

    .container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      padding: 20px;
    }

    .app-container {
      display: flex;
      width: 100%;
      max-width: 1200px;
      height: 90vh;
      max-height: 800px;
      background-color: var(--background-primary);
      border-radius: var(--border-radius);
      box-shadow: 0 8px 30px var(--shadow-color);
      overflow: hidden;
      position: relative;
    }

    .sidebar {
      width: 260px;
      background-color: var(--background-tertiary);
      padding: 20px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border-color);
    }

    .back-to-home-link {
        display: flex;
        align-items: center;
        padding: 8px 5px;
        margin-bottom: 15px; /* Space before logo */
        font-size: 14px;
        color: var(--text-secondary);
        text-decoration: none;
        border-radius: var(--border-radius);
        transition: background-color 0.2s, color 0.2s;
    }
    .back-to-home-link:hover {
        background-color: var(--background-secondary);
        color: var(--primary-color);
    }
    .back-to-home-link i {
        margin-right: 10px;
        font-size: 16px;
        width: 18px; /* Align with other icons */
        text-align: center;
    }


    .logo {
      display: flex;
      align-items: center;
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 24px;
      color: var(--primary-color);
    }

    .logo i {
      margin-right: 10px;
      font-size: 24px;
    }

    .new-chat-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 12px;
      border-radius: var(--border-radius);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 20px;
      transition: background-color 0.2s, transform 0.1s;
    }

    .new-chat-btn:hover {
      background-color: var(--secondary-color);
      transform: translateY(-2px);
    }

    .new-chat-btn i {
      margin-right: 8px;
    }

    .history-container {
      flex: 1;
      overflow-y: auto;
    }
    .history-container::-webkit-scrollbar {
        width: 6px;
    }
    .history-container::-webkit-scrollbar-thumb {
        background-color: var(--secondary-color);
        border-radius: 3px;
    }
    .history-container::-webkit-scrollbar-track {
        background-color: var(--background-secondary);
    }


    .history-container h3 {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      padding-left: 5px;
    }

    .chat-history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-radius: var(--border-radius);
      margin-bottom: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 14px;
      position: relative;
    }

    .chat-history-item-title {
      display: flex;
      align-items: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex-grow: 1;
    }

    .chat-history-item-title i {
      margin-right: 10px;
      color: var(--text-secondary);
      font-size: 14px;
      flex-shrink: 0;
    }

    .chat-history-item-title span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }


    .chat-history-item:hover {
      background-color: var(--background-secondary);
    }

    .chat-history-item.active {
      background-color: rgba(124, 77, 255, 0.1);
      font-weight: 500;
    }
    .chat-history-item.active .chat-history-item-title i {
        color: var(--primary-color);
    }

    .delete-chat-btn {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 12px;
        padding: 5px;
        border-radius: 50%;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s, color 0.2s;
        margin-left: 5px;
        flex-shrink: 0;
    }

    .chat-history-item:hover .delete-chat-btn {
        opacity: 1;
    }
    .delete-chat-btn:hover {
        color: #ff4d4d;
    }


    .settings {
      margin-top: 20px;
      border-top: 1px solid var(--border-color);
      padding-top: 15px;
    }

    .settings button {
      display: flex;
      align-items: center;
      background: none;
      border: none;
      color: var(--text-secondary);
      padding: 10px 5px;
      width: 100%;
      text-align: left;
      cursor: pointer;
      border-radius: var(--border-radius);
      font-size: 14px;
      transition: background-color 0.2s, color 0.2s;
    }

    .settings button:hover {
      background-color: var(--background-secondary);
      color: var(--text-primary);
    }

    .settings button i {
      margin-right: 10px;
      width: 16px;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: var(--background-primary);
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 25px;
      border-bottom: 1px solid var(--border-color);
      min-height: 60px;
    }

    .current-chat-title {
      font-weight: 600;
      font-size: 16px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: calc(100% - 200px); /* Adjusted for new copy button */
    }

    .header-actions button {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 16px;
      padding: 8px;
      border-radius: var(--border-radius);
      transition: color 0.2s, background-color 0.2s, opacity 0.2s;
      margin-left: 5px;
    }
    .header-actions button:disabled {
        color: var(--border-color);
        cursor: not-allowed;
        opacity: 0.6;
    }
    .header-actions button:not(:disabled):hover {
      color: var(--primary-color);
      background-color: var(--background-tertiary);
    }
    .header-actions button.copied-feedback {
        color: #4caf50 !important; /* Green for copied */
    }


    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 0;
    }
    .messages::-webkit-scrollbar {
        width: 8px;
    }
    .messages::-webkit-scrollbar-thumb {
        background-color: var(--secondary-color);
        border-radius: 4px;
    }
    .messages::-webkit-scrollbar-track {
        background-color: var(--background-primary);
    }


    .message {
      display: flex;
      flex-direction: column; /* To stack content and timestamp */
      margin: 10px 25px;
      animation: fadeIn 0.3s ease-out;
    }
    .message.user {
        align-items: flex-end;
    }
    .message.ai {
        align-items: flex-start;
    }


    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-bubble { /* New wrapper for content + file info */
        max-width: 80%;
        padding: 12px 16px;
        border-radius: var(--border-radius);
        font-size: 15px;
        line-height: 1.6;
        word-wrap: break-word;
    }
    .message.ai .message-bubble {
      background-color: var(--ai-message-bg);
      color: var(--text-primary);
    }
    .message.user .message-bubble {
      background-color: var(--user-message-bg);
      color: var(--user-message-text);
    }

    .message-file-info {
        font-size: 0.8em;
        opacity: 0.8;
        margin-top: 5px;
        border-top: 1px dashed rgba(255,255,255,0.3);
        padding-top: 5px;
    }
    .message.ai .message-file-info { /* For AI messages if they were to have files */
        border-top: 1px dashed var(--border-color);
    }

    .message-timestamp {
        font-size: 0.75em;
        color: var(--text-secondary);
        margin-top: 4px;
        padding: 0 5px; /* Align with bubble padding */
    }
    .message.user .message-timestamp {
        text-align: right;
    }
     .message.ai .message-timestamp {
        text-align: left;
    }


    /* Markdown styling for AI messages (applied within .message-bubble) */
    .message.ai .message-bubble h1,
    .message.ai .message-bubble h2,
    .message.ai .message-bubble h3,
    .message.ai .message-bubble h4,
    .message.ai .message-bubble h5,
    .message.ai .message-bubble h6 {
      margin-top: 1em;
      margin-bottom: 0.5em;
      font-weight: 600;
    }
    .message.ai .message-bubble h1 { font-size: 1.8em; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em;}
    .message.ai .message-bubble h2 { font-size: 1.5em; }
    .message.ai .message-bubble h3 { font-size: 1.25em; }
    .message.ai .message-bubble p { margin-bottom: 0.8em; }


    .message.ai .message-bubble ul,
    .message.ai .message-bubble ol {
      margin: 8px 0;
      padding-left: 25px;
    }

    .message.ai .message-bubble li {
      margin-bottom: 5px;
    }

    .message.ai .message-bubble blockquote {
      border-left: 4px solid var(--primary-color);
      padding: 5px 0 5px 15px;
      margin: 10px 0;
      color: var(--text-secondary);
      background-color: var(--background-tertiary);
      border-radius: 0 var(--border-radius) var(--border-radius) 0;
    }

    .message.ai .message-bubble table {
      border-collapse: collapse;
      width: 100%;
      margin: 15px 0;
      box-shadow: 0 2px 4px var(--shadow-color);
      border-radius: var(--border-radius);
      overflow: hidden;
    }

    .message.ai .message-bubble th,
    .message.ai .message-bubble td {
      border: 1px solid var(--border-color);
      padding: 10px 14px;
      text-align: left;
    }

    .message.ai .message-bubble th {
      background-color: var(--background-tertiary);
      font-weight: 600;
    }
    .message.ai .message-bubble tr:nth-child(even) {
        background-color: var(--background-secondary);
    }


    .message.ai .message-bubble a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }

    .message.ai .message-bubble a:hover {
      text-decoration: underline;
      color: var(--secondary-color);
    }

    .message.ai .message-bubble hr {
      border: none;
      height: 1px;
      background-color: var(--border-color);
      margin: 20px 0;
    }

    .hljs {
        background: #282c34 !important;
        color: #abb2bf !important;
        border-radius: var(--border-radius);
    }
    .dark-mode .hljs {
        background: #21252b !important;
    }

    .hljs-keyword,
    .hljs-selector-tag,
    .hljs-literal,
    .hljs-type,
    .hljs-tag {
      color: #c678dd;
    }

    .hljs-number,
    .hljs-string,
    .hljs-regexp,
    .hljs-template-variable,
    .hljs-attribute
     {
      color: #98c379;
    }
    .hljs-variable,
    .hljs-params,
    .hljs-class .hljs-title,
    .hljs-built_in {
        color: #e06c75;
    }

    .hljs-function > .hljs-title,
    .hljs-title.function_,
    .hljs-title.class_
     {
      color: #61afef;
    }
    .hljs-comment,
    .hljs-doctag,
    .hljs-quote,
    .hljs-deletion {
        color: #5c6370;
    }
    .hljs-meta,
    .hljs-section,
    .hljs-emphasis {
        color: #e5c07b;
    }


    pre {
      position: relative;
      background-color: #282c34;
      border-radius: var(--border-radius);
      padding: 16px;
      padding-top: 45px;
      overflow-x: auto;
      margin: 15px 0;
      border: 1px solid #3e4451;
      color: #abb2bf;
    }

    pre::before {
      content: attr(data-lang);
      position: absolute;
      top: 10px;
      left: 12px;
      font-size: 12px;
      color: #aaa;
      font-weight: bold;
      text-transform: uppercase;
    }


    code {
      font-family: "Fira Code", "Courier New", Courier, monospace;
      font-size: 14px;
    }

    pre code.hljs {
      padding: 0;
      background: none !important;
      font-size: 14px;
      line-height: 1.5;
    }

    :not(pre)>code {
      background-color: var(--background-tertiary);
      padding: 3px 6px;
      border-radius: 4px;
      color: var(--primary-color);
      font-size: 0.9em;
    }
    .dark-mode :not(pre)>code {
        background-color: var(--ai-message-bg);
    }


    .typing-indicator {
      display: flex;
      align-items: center;
      padding: 15px 25px;
      opacity: 0;
      transition: opacity 0.3s;
      height: 0;
      overflow: hidden;
    }
    .typing-indicator.visible {
        opacity: 1;
        height: auto;
        margin-bottom: 10px;
    }


    .typing-dot {
      width: 8px;
      height: 8px;
      margin: 0 3px;
      background-color: var(--typing-indicator-color);
      border-radius: 50%;
      opacity: 0.7;
      animation: typingAnimation 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingAnimation {
      0%, 80%, 100% {
        transform: scale(0.5);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .input-area {
      padding: 15px 25px 20px;
      border-top: 1px solid var(--border-color);
      background-color: var(--background-primary);
    }

    .input-container {
      display: flex;
      align-items: center;
      position: relative;
      background-color: var(--background-tertiary);
      border-radius: var(--border-radius);
      overflow: hidden;
      border: 1px solid transparent;
      transition: border-color 0.2s;
    }
    .input-container:focus-within {
        border-color: var(--primary-color);
    }


    #file-upload-button {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 18px;
      padding: 15px;
      cursor: pointer;
      transition: color 0.2s;
    }

    #file-upload-button:hover {
      color: var(--primary-color);
    }

    textarea {
      flex: 1;
      border: none;
      background: none;
      padding: 15px;
      font-size: 15px;
      resize: none;
      min-height: 24px;
      max-height: 150px;
      color: var(--text-primary);
      outline: none;
      line-height: 1.6;
    }

    textarea::placeholder {
      color: var(--text-secondary);
    }

    #send-button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      width: 48px;
      height: 48px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
      align-self: flex-end;
      margin: 4px;
      border-radius: var(--border-radius);
    }
    #send-button:disabled {
        background-color: var(--text-secondary);
        cursor: not-allowed;
    }

    #send-button:not(:disabled):hover {
      background-color: var(--secondary-color);
    }

    .disclaimer {
      font-size: 12px;
      color: var(--text-secondary);
      text-align: center;
      margin-top: 10px;
    }

    #pending-file-preview {
      display: none;
      align-items: center;
      gap: 8px;
      margin: 10px 0 5px;
      padding: 8px 12px;
      background-color: var(--background-tertiary);
      border-radius: var(--border-radius);
      font-size: 13px;
      color: var(--text-primary);
    }
    #pending-file-preview i {
        color: var(--primary-color);
    }
    #pending-file-preview button {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 14px;
        margin-left: auto;
    }
    #pending-file-preview button:hover {
        color: #ff4d4d;
    }


    .intro-message-container {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow-y: auto;
        padding: 20px;
    }

    .intro-message {
      text-align: center;
      max-width: 600px;
      padding: 30px;
      background-color: var(--background-primary);
      border-radius: var(--border-radius);
      box-shadow: 0 5px 15px var(--shadow-color);
      animation: fadeIn 0.5s ease-out;
    }

    .intro-message h1 {
      color: var(--primary-color);
      font-size: 28px;
      margin-bottom: 15px;
    }

    .intro-message p {
      color: var(--text-secondary);
      margin-bottom: 25px;
      font-size: 16px;
      line-height: 1.6;
    }

    .suggestion-chips {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 20px; /* Added margin for spacing */
    }

    .suggestion-chip {
      background-color: var(--background-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .suggestion-chip:hover {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: 0 2px 5px var(--shadow-color);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="app-container">
      <div class="sidebar">
         <a href="/" class="back-to-home-link">
            <i class="fas fa-home"></i>
            <span>Back to Home</span>
          </a>
        <div class="logo">
          <i class="fas fa-graduation-cap"></i> <span>Alumni Portal</span> </div>
        <button id="new-chat" class="new-chat-btn">
          <i class="fas fa-plus"></i>
          <span>New Chat</span>
        </button>
        <div class="history-container">
          <h3>Chat History</h3>
          <div id="chat-history">
            </div>
        </div>
        <div class="settings">
          <button id="clear-history">
            <i class="fas fa-trash"></i>
            <span>Clear All History</span>
          </button>
          <button id="toggle-theme">
            <i class="fas fa-moon"></i>
            <span id="theme-button-text">Dark Mode</span>
          </button>
        </div>
      </div>
      <div class="chat-container">
        <div class="chat-header">
          <div class="current-chat-title" id="current-chat-title">
            Alumni Assistant
          </div>
          <div class="header-actions">
             <button id="copy-last-response" title="Copy last AI response" disabled>
                <i class="fas fa-copy"></i>
            </button>
            <button id="regenerate-response" title="Regenerate response" disabled>
              <i class="fas fa-sync"></i>
            </button>
            <button id="stop-response" title="Stop generating" style="display: none;">
              <i class="fas fa-stop"></i>
            </button>
            <button id="export-chat" title="Export conversation" disabled>
              <i class="fas fa-download"></i>
            </button>
          </div>
        </div>
        <div class="messages" id="messages">
          </div>
        <div class="typing-indicator" id="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
        <div class="input-area">
          <div id="pending-file-preview">
            <i class="fas fa-file-alt"></i>
            <span id="pending-file-name"></span>
            <button id="remove-pending-file" title="Remove file">&times;</button>
          </div>
          <div class="input-container">
            <button id="file-upload-button" title="Upload File">
              <i class="fas fa-paperclip"></i>
            </button>
            <input type="file" id="file-upload" style="display: none" />
            <textarea id="user-input" placeholder="Ask the Alumni Assistant..." rows="1"></textarea>
            <button id="send-button" title="Send message" disabled>
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
          <div class="disclaimer">
            Alumni Assistant may produce inaccurate information. Messages are stored locally.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // DOM Elements
      const messagesContainer = document.getElementById("messages");
      const userInput = document.getElementById("user-input");
      const sendButton = document.getElementById("send-button");
      const newChatButton = document.getElementById("new-chat");
      const clearHistoryButton = document.getElementById("clear-history");
      const toggleThemeButton = document.getElementById("toggle-theme");
      const themeButtonText = document.getElementById("theme-button-text");
      const themeIcon = toggleThemeButton.querySelector("i");
      const chatHistoryContainer = document.getElementById("chat-history");
      const currentChatTitleElement = document.getElementById("current-chat-title");
      const exportChatButton = document.getElementById("export-chat");
      const regenerateResponseButton = document.getElementById("regenerate-response");
      const copyLastResponseButton = document.getElementById("copy-last-response");
      const stopResponseButton = document.getElementById("stop-response");
      const fileUploadButton = document.getElementById("file-upload-button");
      const fileUploadInput = document.getElementById("file-upload");
      const typingIndicator = document.getElementById("typing-indicator");
      const pendingFilePreview = document.getElementById("pending-file-preview");
      const pendingFileName = document.getElementById("pending-file-name");
      const removePendingFileButton = document.getElementById("remove-pending-file");

      // --- Gemini API Configuration ---
      const GEMINI_API_KEY = "AIzaSyCryeRzLO0Wc_7avWkeTBBpllkqNcsK5xg"; // User's Test API Key
      const GEMINI_MODEL_ID = "gemini-1.5-flash-latest";
      const GENERATE_CONTENT_API_METHOD = "generateContent"; // Using non-streaming endpoint

      // Original detailed system instruction
      const ALUMNI_PORTAL_SYSTEM_INSTRUCTION = `Alumni Portal Assistant â€“ System Instruction for Gemini API

ROLE:
You are a polite, professional, and helpful virtual assistant for the College Alumni Portal.

PURPOSE:
Your role is to guide, assist, and support alumni, students, and other users on the portal. You must provide information related to:
- Career Guidance
- Mentorship Opportunities
- Internships & Job Openings
- Events and News Updates
- Scholarship Details
- Profile Help
- Alumni Engagement and Networking
- General Portal Navigation

You act like a human assistant, with clear, concise, and friendly replies.

---

INITIAL WELCOME MESSAGE:
When a user starts a new chat, and there are no prior messages from the user in the current session, respond with:

ðŸ‘‹ Hello! I'm your Alumni Portal Assistant, here to help you with career guidance, internships, scholarships, alumni support, and more.

Before we begin, could you please provide the following details to proceed?

1. Full Name:
2. Email ID:
3. GR Number:

This helps me verify you're a genuine user. ðŸ˜Š

---

POST-VERIFICATION PROMPT:
Once the user shares their details (you should assess if the user's response seems to contain these details), respond with:

âœ… Thank you, [Name]! You're all set. How can I assist you today? (Extract [Name] from user's response if possible, otherwise use "Thank you! You're all set.")

You can ask me about:
- ðŸŽ“ Career Guidance
- ðŸ‘¨â€ðŸ« Mentorship Programs
- ðŸ’¼ Internship and Job Opportunities
- ðŸŽ‰ Upcoming Events
- ðŸ“° Latest News
- ðŸŽ Scholarships
- ðŸ‘¥ Alumni Networking
- ðŸ“˜ Help with Your Profile or Portal

Just type your question, and Iâ€™ll do my best to help you!

---

RESPONSE STYLE & BEHAVIOR:
- Response should be concise.
- Always be polite, warm, and supportive.
- If the user seems confused, gently guide them with examples.
- If you donâ€™t have an answer, respond with:
  "Iâ€™m sorry, I couldnâ€™t find that information right now. Would you like me to forward your query to the admin team?"
- Use emoji sparingly to add friendliness (e.g., âœ…, ðŸŽ“, ðŸ’¬).

---

EXAMPLE QUERIES THE ASSISTANT SHOULD HANDLE:
- â€œCan you suggest internship programs in my field?â€
- â€œHow can I connect with alumni mentors?â€
- â€œWhere can I check upcoming alumni events?â€
- â€œWhat scholarships are available for final year students?â€
- â€œI forgot my GR number, what should I do?â€
- â€œCan you help me update my profile?â€

---

NOTE ON PRIVACY:
- Never store or share user information outside the session scope.
- If the user requests to contact admin or support, respond with:
  "Sure! Iâ€™ll notify the admin team. Please expect a reply on your registered email soon."

---

OPTIONAL: USER ROLE SELECTION
If your system supports multiple user roles (Alumni, Student, Admin), you can ask:

Thanks! Just to assist you better, can you please select your user type?
1. Student
2. Alumni
3. Admin

HANDLING IRRELEVANT QUESTIONS:
- Do not engage in irrelevant or off-topic questions from users.
- If a user asks something not related to the Alumni Portal services (such as random chatting, personal advice, or platform suggestions), respond with:
  "I'm sorry, I can't assist you with this."
- Examples of irrelevant questions include:
  - Casual chat like â€œHowâ€™s your day?â€
  - Platform suggestions like â€œYou should add a dark mode.â€
  - AI interaction requests like â€œTell me a jokeâ€ or â€œLetâ€™s talk about movies.â€

Stay focused on supporting the Alumni Portal features only.
`;


      // State variables
      let currentChatId = null;
      let chatHistory = {};
      let isAIGenerating = false;
      let currentAbortController = null;
      let pendingFile = null;

      // --- Initialization ---
      loadTheme();
      loadChatHistoryFromStorage();
      renderChatHistorySidebar();
      initializeCurrentChat();
      updateHeaderButtonsState();
      updateSendButtonState();


      // --- Event Listeners ---
      sendButton.addEventListener("click", handleSendMessage);
      userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          handleSendMessage();
        }
      });
      userInput.addEventListener("input", () => {
        autoResizeTextarea();
        updateSendButtonState();
      });

      newChatButton.addEventListener("click", () => startNewChat(true));
      clearHistoryButton.addEventListener("click", confirmClearAllHistory);
      toggleThemeButton.addEventListener("click", toggleTheme);
      exportChatButton.addEventListener("click", exportConversation);
      regenerateResponseButton.addEventListener("click", regenerateLastAIResponse);
      copyLastResponseButton.addEventListener("click", handleCopyLastAIResponse);
      stopResponseButton.addEventListener("click", stopAIResponse);

      fileUploadButton.addEventListener("click", () => fileUploadInput.click());
      fileUploadInput.addEventListener("change", handleFileSelection);
      removePendingFileButton.addEventListener("click", removePendingFile);


      // --- Core Chat Functions ---
      function handleSendMessage() {
        const messageText = userInput.value.trim();
        if (!messageText && !pendingFile) return;
        if (isAIGenerating) return;

        if (!currentChatId || !chatHistory[currentChatId]) {
            startNewChat(false);
        }

        const introMsgContainer = messagesContainer.querySelector(".intro-message-container");
        if (introMsgContainer) introMsgContainer.remove();

        const userMessage = {
          id: Date.now(),
          sender: "user",
          text: messageText,
          file: pendingFile ? { name: pendingFile.name, type: pendingFile.type, size: pendingFile.size } : null
        };
        addMessageToUI(userMessage);
        chatHistory[currentChatId].messages.push(userMessage);

        if (chatHistory[currentChatId].messages.length === 1 && chatHistory[currentChatId].title === "Alumni Assistant Chat") {
            const newTitle = messageText.substring(0, 25) + (messageText.length > 25 ? "..." : "");
            chatHistory[currentChatId].title = newTitle || "Chat";
            updateChatTitleUI(chatHistory[currentChatId].title);
            renderChatHistorySidebar();
        }

        saveChatHistoryToStorage();
        fetchAIResponse();

        userInput.value = "";
        removePendingFile();
        autoResizeTextarea();
        updateSendButtonState();
        updateHeaderButtonsState();
      }

      async function fetchAIResponse() {
        if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
             addMessageToUI({ id: Date.now(), sender: "ai", text: "Error: GEMINI_API_KEY is still a placeholder. Please ensure it's set correctly." });
             isAIGenerating = false;
             showTypingIndicator(false);
             updateHeaderButtonsState();
             return;
        }
        if (!currentChatId || !chatHistory[currentChatId]) return;

        isAIGenerating = true;
        currentAbortController = new AbortController();
        showTypingIndicator(true);
        updateHeaderButtonsState();

        const historyForAPI = chatHistory[currentChatId].messages.filter(msg => {
            const textContent = msg.text + (msg.file ? `\n[Attached file: ${msg.file.name} (${msg.file.type}, ${formatFileSize(msg.file.size)})]` : "");
            return textContent.trim() !== "";
        });

        const messagesForAPI = historyForAPI.map(msg => ({
          role: msg.sender === "user" ? "user" : "model",
          parts: [{ text: msg.text + (msg.file ? `\n[Attached file: ${msg.file.name} (${msg.file.type}, ${formatFileSize(msg.file.size)})]` : "") }]
        }));

        let aiMessagePlaceholderDiv = addMessageToUI({id: Date.now() + Math.random(), sender:"ai", text: ""}, true);

        if (messagesForAPI.length === 0) {
            console.warn("fetchAIResponse: No valid messages (non-empty text) to send to the API.");
            const noMsgErrorText = "There's no message content to send to the AI.";
            renderMarkdownAndHighlight(aiMessagePlaceholderDiv, noMsgErrorText);
            const lastMessageInHistory = chatHistory[currentChatId].messages[chatHistory[currentChatId].messages.length -1];
            if (lastMessageInHistory && lastMessageInHistory.sender === 'ai' && lastMessageInHistory.text === "") {
                lastMessageInHistory.text = noMsgErrorText;
            }
            saveChatHistoryToStorage();
            isAIGenerating = false;
            showTypingIndicator(false);
            updateHeaderButtonsState();
            return;
        }

        const requestBody = {
          contents: messagesForAPI,
          system_instruction: { // Re-adding the system instruction
            parts: [{ text: ALUMNI_PORTAL_SYSTEM_INSTRUCTION }]
          },
          generationConfig: {
            // temperature: 1,
            // topP: 0.95,
            // topK: 64,
            // maxOutputTokens: 8192,
          }
        };

        console.log(`Requesting Gemini API with NON-STREAMING endpoint (${GENERATE_CONTENT_API_METHOD}) and body (WITH SYSTEM INSTRUCTION):`, JSON.stringify(requestBody, null, 2));

        const API_URL_GEMINI = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL_ID}:${GENERATE_CONTENT_API_METHOD}?key=${GEMINI_API_KEY}`;

        let aiText = "";
        let messageIdForHistory = parseFloat(aiMessagePlaceholderDiv.parentElement.dataset.messageId);


        try {
          const response = await fetch(API_URL_GEMINI, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestBody),
            signal: currentAbortController.signal
          });

          if (currentAbortController.signal.aborted) {
            aiText = "Generation stopped by user.";
            renderMarkdownAndHighlight(aiMessagePlaceholderDiv, aiText);
            // History update is handled in finally block
            return;
          }

          const responseData = await response.json();
          console.log("Full API Response Data:", JSON.stringify(responseData, null, 2));


          if (!response.ok) {
            console.error("API Error:", response.status, responseData);
            let errorMsg = `Error: ${response.statusText} (Status: ${response.status}).`;
            if (responseData.error && responseData.error.message) {
                errorMsg += ` Details: ${responseData.error.message}`;
            }
            aiText = errorMsg;
          } else {
            if (responseData.candidates && responseData.candidates[0]) {
                const candidate = responseData.candidates[0];
                if (candidate.finishReason && candidate.finishReason !== "STOP" && candidate.finishReason !== "MAX_TOKENS") {
                    console.warn("IMPORTANT - API returned finishReason:", candidate.finishReason, "Safety Ratings:", JSON.stringify(candidate.safetyRatings, null, 2));
                    aiText = `Response generation stopped. Reason: ${candidate.finishReason}.`;
                    if (candidate.finishReason === "SAFETY") {
                        aiText += " This may be due to content safety filters.";
                    }
                } else if (candidate.content && candidate.content.parts && candidate.content.parts[0] && candidate.content.parts[0].text) {
                    aiText = candidate.content.parts[0].text;
                    console.log("Received AI Text:", `"${aiText}"`);
                } else {
                    console.warn("API response OK, but no text content found in the expected location. Full candidate:", JSON.stringify(candidate, null, 2));
                    aiText = "Sorry, I received a response, but it was empty.";
                }
            } else if (responseData.promptFeedback && responseData.promptFeedback.blockReason) {
                 console.warn("IMPORTANT - Prompt was blocked by API. Reason:", responseData.promptFeedback.blockReason, "Safety Ratings:", JSON.stringify(responseData.promptFeedback.safetyRatings, null, 2));
                 aiText = `Your request was blocked by the API. Reason: ${responseData.promptFeedback.blockReason}.`;
            }
            else {
                console.warn("API response OK, but no candidates or expected content structure found.");
                aiText = "Sorry, I couldn't understand the API's response format.";
            }
          }
        } catch (error) {
          if (error.name === 'AbortError') {
            console.log('Fetch aborted by user.');
            aiText = "Generation stopped by user.";
          } else {
            console.error("Error fetching or parsing AI response:", error);
            aiText = "An error occurred while fetching/parsing the response. Check console.";
          }
        } finally {
          renderMarkdownAndHighlight(aiMessagePlaceholderDiv, aiText || "Sorry, I couldn't generate a response.");

          const messageToUpdate = chatHistory[currentChatId].messages.find(m => m.id === messageIdForHistory);
          if (messageToUpdate) {
            messageToUpdate.text = aiText || "Sorry, I couldn't generate a response.";
          } else {
            console.error("CRITICAL: Placeholder message for history not found with ID:", messageIdForHistory);
             chatHistory[currentChatId].messages.push({ id: messageIdForHistory, sender: "ai", text: aiText || "Sorry, I couldn't generate a response." });
          }
          saveChatHistoryToStorage();

          isAIGenerating = false;
          showTypingIndicator(false);
          updateHeaderButtonsState();
          currentAbortController = null;
        }
      }

      function regenerateLastAIResponse() {
        if (isAIGenerating || !currentChatId || !chatHistory[currentChatId]) return;
        const currentMessages = chatHistory[currentChatId].messages;
        if (currentMessages.length === 0) return;

        let lastAiMessageIndex = -1;
        for (let i = currentMessages.length - 1; i >= 0; i--) {
            if (currentMessages[i].sender === 'ai') {
                lastAiMessageIndex = i;
                break;
            }
        }

        if (lastAiMessageIndex !== -1) {
            currentMessages.splice(lastAiMessageIndex);
        } else {
            if (currentMessages.every(m => m.sender === 'user')) {
                return;
            }
        }

        messagesContainer.innerHTML = '';
        currentMessages.forEach(msg => addMessageToUI(msg, true));

        saveChatHistoryToStorage();
        if (currentMessages.some(m => m.sender === 'user')) {
            fetchAIResponse();
        } else {
            showIntroMessage();
        }
      }

      function stopAIResponse() {
        if (isAIGenerating && currentAbortController) {
          currentAbortController.abort();
        }
      }

      function handleCopyLastAIResponse() {
        if (!currentChatId || !chatHistory[currentChatId] || isAIGenerating) return;

        const messages = chatHistory[currentChatId].messages;
        let lastAiText = null;
        for (let i = messages.length - 1; i >= 0; i--) {
            if (messages[i].sender === 'ai' && messages[i].text.trim() !== "") {
                lastAiText = messages[i].text;
                break;
            }
        }

        if (lastAiText) {
            navigator.clipboard.writeText(lastAiText).then(() => {
                copyLastResponseButton.innerHTML = '<i class="fas fa-check"></i>';
                copyLastResponseButton.classList.add("copied-feedback");
                setTimeout(() => {
                    copyLastResponseButton.innerHTML = '<i class="fas fa-copy"></i>';
                    copyLastResponseButton.classList.remove("copied-feedback");
                }, 2000);
            }).catch(err => {
                console.error("Failed to copy AI response:", err);
                // Optionally, show an error to the user in a less intrusive way
            });
        } else {
            // Optionally, inform user no AI response to copy
            console.log("No AI response to copy.");
        }
    }


      function addMessageToUI(message, skipTypingEffect = false) { // skipTypingEffect is less relevant for non-streaming
        const messageElement = document.createElement("div");
        messageElement.classList.add("message", message.sender);
        messageElement.dataset.messageId = String(message.id);

        const messageBubble = document.createElement("div"); // New bubble wrapper
        messageBubble.classList.add("message-bubble");

        if (message.sender === "ai") {
             renderMarkdownAndHighlight(messageBubble, message.text || "...");
        } else {
          messageBubble.textContent = message.text;
        }

        if (message.file) {
            const fileInfoElement = document.createElement('div');
            fileInfoElement.classList.add('message-file-info');
            fileInfoElement.innerHTML = `<i class="fas fa-paperclip"></i> ${message.file.name} (${formatFileSize(message.file.size)})`;
            messageBubble.appendChild(fileInfoElement); // Append to bubble
        }

        messageElement.appendChild(messageBubble); // Add bubble to message element

        // Timestamp
        const timestampElement = document.createElement("div");
        timestampElement.classList.add("message-timestamp");
        timestampElement.textContent = new Date(message.id).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        messageElement.appendChild(timestampElement);


        messagesContainer.appendChild(messageElement);
        scrollToBottom();
        return messageBubble; // Return the content bubble for placeholder updates
      }

      function createAIMessagePlaceholder() {
        const messageId = Date.now() + Math.random();
        // AddMessageToUI now returns the content div (bubble)
        const messageContentBubble = addMessageToUI({id: messageId, sender: "ai", text: ""}, true);

        if (currentChatId && chatHistory[currentChatId]) {
            if (!chatHistory[currentChatId].messages.find(m => m.id === messageId)) {
                 chatHistory[currentChatId].messages.push({ id: messageId, sender: "ai", text: "" });
                 saveChatHistoryToStorage();
            }
        }
        // Return the div where AI text will be rendered (the bubble)
        return messageContentBubble;
      }

      function renderMarkdownAndHighlight(element, markdownText) {
        if (typeof marked === 'undefined' || typeof hljs === 'undefined') {
            element.textContent = markdownText;
            return;
        }
        element.innerHTML = marked.parse(markdownText || "");
        element.querySelectorAll("pre code").forEach((block) => {
            const language = block.className.replace("language-", "") || 'plaintext';
            block.parentElement.setAttribute('data-lang', language);
            hljs.highlightElement(block);
            addCopyButtonToCodeBlock(block.parentElement);
        });
      }

      function addCopyButtonToCodeBlock(preElement) {
        if (preElement.querySelector('.code-copy-button')) return;
        const copyButtonContainer = document.createElement("div");
        copyButtonContainer.className = "code-copy-container";
        const button = document.createElement("button");
        button.className = "code-copy-button";
        button.title = "Copy code";
        button.innerHTML = '<i class="fas fa-copy"></i>';
        button.addEventListener("click", () => {
          const codeElement = preElement.querySelector("code");
          const codeToCopy = codeElement ? codeElement.innerText : "";
          navigator.clipboard.writeText(codeToCopy).then(() => {
            button.innerHTML = '<i class="fas fa-check"></i>';
            button.classList.add("copied");
            setTimeout(() => {
              button.innerHTML = '<i class="fas fa-copy"></i>';
              button.classList.remove("copied");
            }, 2000);
          }).catch(err => console.error("Failed to copy code: ", err));
        });
        copyButtonContainer.appendChild(button);
        preElement.appendChild(copyButtonContainer);
      }

      function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function autoResizeTextarea() {
        userInput.style.height = "auto";
        userInput.style.height = userInput.scrollHeight + "px";
      }

      function showTypingIndicator(show) {
        if (show) typingIndicator.classList.add("visible");
        else typingIndicator.classList.remove("visible");
        scrollToBottom();
      }

      function updateChatTitleUI(title) {
        currentChatTitleElement.textContent = title || "Alumni Assistant";
        currentChatTitleElement.title = title || "Alumni Assistant";
      }

      function updateHeaderButtonsState() {
        const hasMessages = currentChatId && chatHistory[currentChatId] && chatHistory[currentChatId].messages.length > 0;
        const hasAIMessages = hasMessages && chatHistory[currentChatId].messages.some(m => m.sender === 'ai' && m.text.trim() !== "" && !m.text.startsWith("Sorry, I couldn't") && !m.text.startsWith("API Error") && !m.text.startsWith("Response generation stopped"));

        exportChatButton.disabled = !hasMessages || isAIGenerating;
        regenerateResponseButton.disabled = !hasAIMessages || isAIGenerating;
        copyLastResponseButton.disabled = !hasAIMessages || isAIGenerating;

        stopResponseButton.style.display = isAIGenerating ? "inline-block" : "none";
        regenerateResponseButton.style.display = isAIGenerating ? "none" : "inline-block";
      }

      function updateSendButtonState() {
        sendButton.disabled = (userInput.value.trim() === "" && !pendingFile) || isAIGenerating;
      }

      function showIntroMessage() {
        messagesContainer.innerHTML = `
            <div class="intro-message-container">
                <div class="intro-message">
                    <h1>Alumni Portal Assistant</h1>
                    <p>I'm here to help with career guidance, internships, events, and more. Type your question to get started, or try one of these common queries:</p>
                    <div class="suggestion-chips">
                        </div>
                </div>
            </div>`;

        const chipsContainer = messagesContainer.querySelector('.suggestion-chips');
        const suggestions = [
            "Find mentorship programs",
            "Upcoming alumni events?",
            "How to update my profile?",
            "Scholarships for final year students"
        ];

        suggestions.forEach(text => {
            const chip = document.createElement('button');
            chip.className = 'suggestion-chip';
            chip.textContent = text;
            chip.onclick = () => {
                userInput.value = text;
                autoResizeTextarea();
                updateSendButtonState();
                handleSendMessage(); // Automatically send after clicking chip
            };
            chipsContainer.appendChild(chip);
        });
      }

      function initializeCurrentChat() {
        const lastChatId = localStorage.getItem("currentChatId");
        if (lastChatId && chatHistory[lastChatId]) {
          loadChat(lastChatId);
        } else if (Object.keys(chatHistory).length > 0) {
          const sortedChats = Object.values(chatHistory).sort((a,b) => (b.updatedAt || b.createdAt) - (a.updatedAt || a.createdAt));
          loadChat(sortedChats[0].id);
        } else {
          startNewChat(true);
        }
      }

      function startNewChat(showUIMessage = true) {
        currentChatId = `chat_${Date.now()}`;
        chatHistory[currentChatId] = {
          id: currentChatId,
          title: "Alumni Assistant Chat",
          messages: [],
          createdAt: Date.now()
        };

        messagesContainer.innerHTML = "";
        if (showUIMessage) {
            showIntroMessage();
        }

        updateChatTitleUI("Alumni Assistant Chat");
        saveChatHistoryToStorage();
        localStorage.setItem("currentChatId", currentChatId);
        renderChatHistorySidebar();
        updateHeaderButtonsState();
        userInput.focus();
      }

      function loadChat(chatId) {
        if (!chatHistory[chatId]) {
            console.warn(`Chat with ID ${chatId} not found. Starting new chat.`);
            startNewChat(true);
            return;
        }
        currentChatId = chatId;
        messagesContainer.innerHTML = "";

        const chat = chatHistory[currentChatId];
        updateChatTitleUI(chat.title);

        if (chat.messages.length === 0) { // Show intro for any empty chat
            showIntroMessage();
        }
        else {
            chat.messages.forEach(msg => addMessageToUI(msg, true));
        }

        localStorage.setItem("currentChatId", currentChatId);
        renderChatHistorySidebar();
        updateHeaderButtonsState();
        scrollToBottom();
      }

      function saveChatHistoryToStorage() {
        if (currentChatId && chatHistory[currentChatId]) {
            chatHistory[currentChatId].updatedAt = Date.now();
        }
        localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
      }

      function loadChatHistoryFromStorage() {
        const storedHistory = localStorage.getItem("chatHistory");
        chatHistory = storedHistory ? JSON.parse(storedHistory) : {};
      }

      function renderChatHistorySidebar() {
        chatHistoryContainer.innerHTML = "";
        const sortedChats = Object.values(chatHistory)
                                .sort((a, b) => (b.updatedAt || b.createdAt) - (a.updatedAt || a.createdAt));

        if (sortedChats.length === 0) {
            chatHistoryContainer.innerHTML = "<p style='padding:10px; font-size:13px; color:var(--text-secondary);'>No chat history yet.</p>";
            return;
        }

        sortedChats.forEach(chat => {
          const item = document.createElement("div");
          item.classList.add("chat-history-item");
          item.dataset.chatId = chat.id;
          if (chat.id === currentChatId) item.classList.add("active");

          const titleDiv = document.createElement('div');
          titleDiv.classList.add('chat-history-item-title');
          titleDiv.innerHTML = `<i class="fas fa-comment-dots"></i><span></span>`;
          titleDiv.querySelector('span').textContent = chat.title || "Chat";
          titleDiv.title = chat.title || "Chat";

          item.appendChild(titleDiv);

          const deleteBtn = document.createElement('button');
          deleteBtn.classList.add('delete-chat-btn');
          deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
          deleteBtn.title = "Delete chat";
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            confirmDeleteChat(chat.id);
          };
          item.appendChild(deleteBtn);

          item.addEventListener("click", () => {
            if (isAIGenerating) {
                if (!confirm("AI is generating a response. Switch chats anyway? This will stop the current generation.")) return;
                stopAIResponse();
            }
            loadChat(chat.id);
          });
          chatHistoryContainer.appendChild(item);
        });
      }

      function confirmDeleteChat(chatId) {
        if (chatHistory[chatId] && confirm(`Delete chat "${chatHistory[chatId].title}"? This cannot be undone.`)) {
            deleteChat(chatId);
        }
      }

      function deleteChat(chatId) {
        if (chatHistory[chatId]) {
            delete chatHistory[chatId];
            saveChatHistoryToStorage();
            renderChatHistorySidebar();
            if (currentChatId === chatId) {
                const remainingChats = Object.keys(chatHistory);
                if (remainingChats.length > 0) loadChat(remainingChats[0]);
                else startNewChat(true);
            }
        }
      }

      function confirmClearAllHistory() {
        if (Object.keys(chatHistory).length === 0) {
            alert("Chat history is already empty.");
            return;
        }
        if (confirm("Clear all chat history? This cannot be undone.")) {
          chatHistory = {};
          currentChatId = null;
          localStorage.removeItem("chatHistory");
          localStorage.removeItem("currentChatId");
          renderChatHistorySidebar();
          startNewChat(true);
        }
      }

      function toggleTheme() {
        const body = document.body;
        body.classList.toggle("dark-mode");
        const isDarkMode = body.classList.contains("dark-mode");
        localStorage.setItem("theme", isDarkMode ? "dark" : "light");
        themeButtonText.textContent = isDarkMode ? "Light Mode" : "Dark Mode";
        themeIcon.className = isDarkMode ? "fas fa-sun" : "fas fa-moon";
      }

      function loadTheme() {
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "dark") {
          document.body.classList.add("dark-mode");
          themeButtonText.textContent = "Light Mode";
          themeIcon.className = "fas fa-sun";
        } else {
          document.body.classList.remove("dark-mode");
          themeButtonText.textContent = "Dark Mode";
          themeIcon.className = "fas fa-moon";
        }
      }

      function exportConversation() {
        if (!currentChatId || !chatHistory[currentChatId] || chatHistory[currentChatId].messages.length === 0) {
          alert("No conversation to export.");
          return;
        }
        const chat = chatHistory[currentChatId];
        let content = `# ${chat.title}\n\nExported on: ${new Date().toLocaleString()}\n\n---\n\n`;
        chat.messages.forEach(msg => {
          content += `**${msg.sender === "user" ? "You" : "Alumni Assistant"}** (${new Date(msg.id).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}):\n`;
          content += msg.text.replace(/\n/g, '\n\n');
          if (msg.file) {
            content += `\n_[Attached file: ${msg.file.name} (${msg.file.type}, ${formatFileSize(msg.file.size)})]_\n`;
          }
          content += "\n\n---\n\n";
        });
        const blob = new Blob([content], { type: "text/markdown;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${chat.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_export.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function handleFileSelection(event) {
        const file = event.target.files[0];
        if (file) {
            if (file.size > 5 * 1024 * 1024) {
                alert("File is too large. Max 5MB.");
                fileUploadInput.value = "";
                return;
            }
            pendingFile = file;
            pendingFileName.textContent = `${file.name} (${formatFileSize(file.size)})`;
            pendingFilePreview.style.display = "flex";
            updateSendButtonState();
        }
      }

      function removePendingFile() {
        pendingFile = null;
        fileUploadInput.value = "";
        pendingFilePreview.style.display = "none";
        pendingFileName.textContent = "";
        updateSendButtonState();
      }

      function formatFileSize(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
      }

    });
  </script>
</body>
</html>
